name: Build Spade UF2
on: # This workflow should run on...
  push: # a push...
    branches: # to one of these branches:
      - 'main'
      - 'add-ci' # TEMP for testing
  workflow_dispatch: # or when manually triggered

defaults:
  run:
    shell: 'bash'

jobs:
  build-uf2:
      runs-on: 'ubuntu-latest' # Run on the latest stable Ubuntu version
      steps:
      - name: 'Setup'
        run: |
          mkdir ~/jerryscript_build
          mkdir ~/raspberrypi

      - name: 'Clone Spade repo'
        run: |
          cd ~/
          git clone https://github.com/hackclub/spade.git
      
      - name: 'Clone JerryScript'
        run: |
          cd ~/jerryscript_build
          git clone https://github.com/jerryscript-project/jerryscript.git
          cd jerryscript
          git checkout 8ba0d1b6ee5a065a42f3b306771ad8e3c0d819bc
          cd ~/spade
          ./pc/jerry/refresh.sh
      
      - name: 'Clone pico-sdk'
        run: |
          cd ~/raspberrypi
          git clone -b 1.3.1 https://github.com/raspberrypi/pico-sdk.git
          git clone https://github.com/raspberrypi/pico-extras.git
          cd pico-sdk
          git submodule update --init
          cd ../pico-extras
          git submodule update --init
      
      - name: 'Build Spade'
        run: |
          cd ~/spade
          cmake --preset=rpi
          cd rpi_build
          make
      
      - name: 'Upload artifact'
        uses: 'actions/upload-artifact@v3'
        with:
          name: 'spade.uf2'
          path: '~/spade/rpi_build/spade.uf2'
          if-no-files-found: error
          
